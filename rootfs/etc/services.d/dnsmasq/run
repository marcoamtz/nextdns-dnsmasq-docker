#!/command/with-contenv sh
# dnsmasq service - starts as root, drops privileges via config

# Wait for NextDNS to be ready (listening on port 5053)
echo "Waiting for NextDNS..."
while ! nc -z 127.0.0.1 5053 2>/dev/null; do
    sleep 1
done

DNSMASQ_VERSION=$(dnsmasq --version 2>/dev/null | head -n1 | awk '{print $3}' || echo "unknown")
echo "Starting dnsmasq version ${DNSMASQ_VERSION}..."

exec dnsmasq -k --log-facility="${LOG_DIR}/dnsmasq.log"
